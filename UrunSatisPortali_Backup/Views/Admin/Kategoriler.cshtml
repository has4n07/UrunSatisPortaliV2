@model IEnumerable<UrunSatisPortali.Models.Kategori>

@{
    ViewData["Title"] = "Kategori Yönetimi";
   
}

<h1>Kategori Yönetimi</h1>

<p>
    <a class="btn btn-success" asp-action="KategoriEkle">Yeni Kategori Ekle</a>
</p>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Ad)
            </th>
            <th>
                İşlemler
            </th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {

            <tr id="satir-@item.Id">

                <td>
                    @Html.DisplayFor(modelItem => item.Ad)
                </td>
                <td>
                    <a class="btn btn-primary btn-sm" asp-action="KategoriDuzenle" asp-route-id="@item.Id">Düzenle</a> |

                    <button type="button" class="btn btn-danger btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#silModal"
                            data-id="@item.Id"
                            data-name="@item.Ad">
                        Sil
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="silModal" tabindex="-1" aria-labelledby="silModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="silModalLabel">Silme Onayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                    <strong><span id="silinecekKategoriAdi"></span></strong> kategorisini silmek istediğinizden emin misiniz?
                </p>
                <p class="text-danger">Bu işlem geri alınamaz.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
                <button type="button" class="btn btn-danger" id="onaylaSilButonu">Sil</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        // Modal (alert box) HTML elementlerini bul
        var silModalElement = document.getElementById('silModal');
        var silModal = new bootstrap.Modal(silModalElement); // Bootstrap'in JS'i ile modalı kontrol et
        var onaylaSilButonu = document.getElementById('onaylaSilButonu');
        var silinecekKategoriAdiSpan = document.getElementById('silinecekKategoriAdi');

        var silinecekId = 0; // Silinecek ID'yi saklamak için değişken

        // 1. Modal (pop-up) açılmak üzereyken...
        silModalElement.addEventListener('show.bs.modal', function (event) {

            // Pop-up'ı açan butonu bul (bizim "Sil" butonumuz)
            var button = event.relatedTarget;

            // Butonun 'data-name' ve 'data-id' özelliklerinden veriyi al
            var kategoriAdi = button.getAttribute('data-name');
            silinecekId = button.getAttribute('data-id'); // ID'yi değişkene ata

            // 2. Kategori adını modal'ın içine yaz (İsteğin 2)
            silinecekKategoriAdiSpan.textContent = kategoriAdi;
        });

        // 3. Modal'daki kırmızı "Sil" butonuna tıklandığında...
        onaylaSilButonu.addEventListener('click', function () {

            // 4. AJAX (fetch) isteğini (AdminController'a) gönder
            fetch('/Admin/KategoriSilAJAX/' + silinecekId, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json'
                    // [ValidateAntiForgeryToken]'ı AdminController'dan kaldırdığımız için
                    // token göndermemize gerek yok.
                }
            })
            .then(response => response.json())
            .then(data => {

                // 5. İşlem bitince modal'ı (pop-up'ı) kapat
                silModal.hide();

                if (data.success) {
                    // 6. Başarılıysa: HTML tablosundan o satırı sil
                    var silinecekSatir = document.getElementById('satir-' + silinecekId);
                    if (silinecekSatir) {
                        silinecekSatir.remove(); // Sayfa yenilenmeden satırı sil
                    }
                    // Eski 'alert()' yerine konsola yazalım, daha temiz.
                    // console.log(data.message);
                } else {
                    // 7. Başarısızsa: Hata mesajını göster
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('AJAX hatası:', error);
                alert('Sunucuya bağlanırken bir hata oluştu.');
                silModal.hide();
            });
        });
    </script>
}